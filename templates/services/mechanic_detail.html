{% extends "base.html" %}
{% block content %}
<div class="container mt-4 mechanic-detail">
  <!-- Mechanic Header -->
  <div class="card shadow-sm p-4 mb-4 rounded-3">
    <h2 class="mb-2">{{ mechanic.service_center_name }}</h2>
    <p class="text-muted mb-1"><strong>Mechanic:</strong> {{ mechanic.user.username }}</p>
    <p class="mb-1"><strong>Phone:</strong> {{ mechanic.phone }}</p>
    <p class="mb-1"><strong>Location:</strong> {{ mechanic.location }}</p>
    
    <div class="rating-box mt-3">
      <h5>⭐ Average Rating: {{ avg_rating }} / 5</h5>
      <small>Based on {{ feedbacks|length }} reviews</small>
    </div>
  </div>

  <!-- Map Section -->
  <div class="card shadow-sm p-4 mb-4 rounded-3">
    <h4 class="mb-3">Location</h4>
    <div id="map" style="height:300px;"></div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const lat = {{ mechanic.latitude|default:"0" }};
    const lng = {{ mechanic.longitude|default:"0" }};
    const m = L.map('map').setView([lat, lng], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap contributors' }).addTo(m);
    L.marker([lat, lng]).addTo(m).bindPopup("{{ mechanic.service_center_name }}");
  </script>

  <!-- Customer Feedback Section -->
  <div class="card shadow-sm p-4 rounded-3">
    <h4>Customer Feedback</h4>
    <p><strong>Average Rating:</strong> {{ mechanic.average_rating }} ⭐</p>

    
    {% if mechanic.feedbacks.all %}
      {% for fb in mechanic.feedbacks.all %}
        <div class="feedback-box mb-3 p-3 border rounded">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <strong>{{ fb.user.username }}</strong>
              <span class="badge bg-warning text-dark ms-2">⭐ {{ fb.rating }}/5</span>
            </div>
            <small class="text-muted">{{ fb.created_at|date:"M d, Y H:i" }}</small>
          </div>
          <p class="mb-0">{{ fb.comment }}</p>
        </div>
      {% endfor %}
    {% else %}
      <p class="text-muted">No feedback yet for this service center.</p>
    {% endif %}

    <!-- Feedback Button -->
    {% if user.is_authenticated %}
      <div class="mt-3">
        <a href="{% url 'give_feedback' mechanic.id %}" class="btn btn-outline-primary">
          Leave Feedback
        </a>
      </div>
    {% else %}
      <p class="mt-3 text-muted">Login to leave feedback.</p>
    {% endif %}
  </div>
</div>

<style>
.mechanic-detail .card {
  border: none;
  border-radius: 15px;
}

.feedback-box {
  background: #f8f9fa;
  border: 1px solid #e9ecef !important;
  border-radius: 10px;
  transition: all 0.3s ease;
}

.feedback-box:hover {
  background: #ffffff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.rating-box {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 1rem;
  border-radius: 10px;
  text-align: center;
}

.rating-box h5 {
  margin: 0;
  font-weight: bold;
}
</style>
{% extends "base.html" %}
{% load static %}
{% block content %}

<style>
  /* Full page background */
  body {
    background: url('/static/image/mech2.jpg') no-repeat center center/cover;
    min-height: 100vh;
    margin: 0;
    display: flex;
    flex-direction: column;
  }

  /* Center the form */
  .form-container {
    flex: 1; /* take remaining height after navbar */
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 20px;
  }

  /* Glassmorphism card */
  .card {
    border-radius: 18px;
    background: rgba(0, 0, 0, 0.55);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
    padding: 30px;
    max-width: 500px;
    width: 100%;
    color: #fff;
  }

  .card-title {
    font-weight: 700;
    font-size: 1.6rem;
    text-align: center;
    margin-bottom: 20px;
  }

  /* Labels */
  form label {
    font-weight: 600;
    color: #e5e7eb;
    margin-bottom: 6px;
    display: block;
  }

  /* Inputs */
  form input, 
  form select, 
  form textarea {
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.3);
    padding: 12px;
    width: 100%;
    background: rgba(255,255,255,0.15);
    color: #fff;
    margin-bottom: 15px;
    box-sizing: border-box;
  }

  form input:focus, 
  form select:focus, 
  form textarea:focus {
    border-color: #16a34a;
    background: rgba(255,255,255,0.25);
    box-shadow: 0 0 8px rgba(22, 163, 74, 0.4);
    outline: none;
  }

  /* Placeholder text */
  form input::placeholder,
  form textarea::placeholder {
    color: #d1d5db;
  }

  /* Location Map Section */
  .location-section {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 20px;
    margin: 20px 0;
    border: 1px solid rgba(255, 255, 255, 0.2);
  }

  .location-title {
    font-weight: 600;
    color: #e5e7eb;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .map-container {
    height: 200px;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid rgba(255, 255, 255, 0.3);
    margin-bottom: 15px;
    background: rgba(0, 0, 0, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
  }

  .location-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    flex-wrap: wrap;
  }

  .btn-location {
    background: rgba(22, 163, 74, 0.8);
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 5px;
    flex: 1;
    justify-content: center;
    min-width: 120px;
  }

  .btn-location:hover {
    background: rgba(21, 128, 61, 0.9);
    transform: translateY(-1px);
  }

  .btn-location.secondary {
    background: rgba(107, 114, 128, 0.8);
  }

  .btn-location.secondary:hover {
    background: rgba(75, 85, 99, 0.9);
  }

  .coordinates-display {
    background: rgba(0, 0, 0, 0.4);
    padding: 12px;
    border-radius: 8px;
    font-family: 'Courier New', monospace;
    font-size: 13px;
    border: 1px dashed rgba(255, 255, 255, 0.2);
  }

  .coordinate-item {
    display: flex;
    justify-content: space-between;
    margin-bottom: 6px;
    padding-bottom: 6px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .coordinate-item:last-child {
    margin-bottom: 0;
    border-bottom: none;
  }

  .coordinate-value {
    font-weight: 600;
    color: #16a34a;
  }

  /* Button */
  .btn-success {
    border-radius: 12px;
    font-weight: 700;
    padding: 12px;
    background: linear-gradient(135deg, #16a34a, #15803d);
    border: none;
    transition: 0.3s;
    width: 100%;
    color: white;
    cursor: pointer;
    margin-top: 10px;
  }

  .btn-success:hover {
    background: linear-gradient(135deg, #15803d, #14532d);
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(0,0,0,0.4);
  }

  .btn-success:disabled {
    background: #6b7280;
    transform: none;
    box-shadow: none;
    cursor: not-allowed;
  }

  /* Form groups */
  .form-group {
    margin-bottom: 15px;
  }

  /* Error styling */
  .errorlist {
    color: #fca5a5;
    list-style: none;
    padding: 0;
    margin: 5px 0 0;
    font-size: 14px;
    background: rgba(220, 38, 38, 0.2);
    padding: 8px 12px;
    border-radius: 6px;
    border-left: 3px solid #ef4444;
  }

  /* Help text */
  .help-text {
    color: #9ca3af;
    font-size: 12px;
    margin-top: 4px;
    display: block;
  }

  /* Spinner */
  .spinner {
    display: inline-block;
    width: 14px;
    height: 14px;
    border: 2px solid #ffffff;
    border-radius: 50%;
    border-top-color: transparent;
    animation: spin 1s ease-in-out infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Hide help text */
  .helptext {
    display: none !important;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .card {
      padding: 20px;
      margin: 10px;
    }
    
    .location-controls {
      flex-direction: column;
    }
    
    .btn-location {
      min-width: auto;
    }
    
    .map-container {
      height: 180px;
    }
  }
</style>

<div class="form-container">
  <div class="card">
    <h4 class="card-title">Mechanic / Service Center Registration</h4>
    <form method="post" id="mechanicForm">{% csrf_token %}
      
      <!-- Username -->
      <div class="form-group">
        <label for="{{ form.username.id_for_label }}">Username</label>
        {{ form.username }}
        {% if form.username.errors %}
          {{ form.username.errors }}
        {% endif %}
      </div>

      <!-- Email -->
      <div class="form-group">
        <label for="{{ form.email.id_for_label }}">Email Address</label>
        {{ form.email }}
        {% if form.email.errors %}
          {{ form.email.errors }}
        {% endif %}
      </div>

      <!-- Passwords -->
      <div class="form-group">
        <label for="{{ form.password1.id_for_label }}">Password</label>
        {{ form.password1 }}
        {% if form.password1.errors %}
          {{ form.password1.errors }}
        {% endif %}
      </div>

      <div class="form-group">
        <label for="{{ form.password2.id_for_label }}">Confirm Password</label>
        {{ form.password2 }}
        {% if form.password2.errors %}
          {{ form.password2.errors }}
        {% endif %}
      </div>

      <!-- Service Center Name -->
      <div class="form-group">
        <label for="{{ form.service_center_name.id_for_label }}">Service Center Name</label>
        {{ form.service_center_name }}
        {% if form.service_center_name.errors %}
          {{ form.service_center_name.errors }}
        {% endif %}
      </div>

      <!-- Phone -->
      <div class="form-group">
        <label for="{{ form.phone.id_for_label }}">Phone Number</label>
        {{ form.phone }}
        {% if form.phone.errors %}
          {{ form.phone.errors }}
        {% endif %}
      </div>

      <!-- Location Address -->
      <div class="form-group">
        <label for="{{ form.location.id_for_label }}">Service Center Address</label>
        {{ form.location }}
        {% if form.location.errors %}
          {{ form.location.errors }}
        {% endif %}
        <small class="help-text">Full address where customers can find your service center</small>
      </div>

      <!-- Location Map Section -->
      <div class="location-section">
        <div class="location-title">
          üìç Pinpoint Your Location
        </div>
        <p style="color: #d1d5db; font-size: 14px; margin-bottom: 15px;">
          Accurate coordinates help us assign nearby service requests
        </p>
        
        <div class="location-controls">
          <button type="button" class="btn-location" onclick="getCurrentLocation()">
            <span class="spinner" id="locationSpinner" style="display: none;"></span>
            üìç Current Location
          </button>
          <button type="button" class="btn-location secondary" onclick="clearLocation()">
            üóëÔ∏è Clear
          </button>
        </div>
        
        <div class="map-container" id="map">
          <div style="color: #9ca3af; padding: 20px;">
            <div style="font-size: 32px; margin-bottom: 8px;">üó∫Ô∏è</div>
            <div>Click "Current Location" to detect your coordinates</div>
          </div>
        </div>
        
        <div class="coordinates-display">
          <div class="coordinate-item">
            <span>Latitude:</span>
            <span class="coordinate-value" id="latDisplay">Not set</span>
          </div>
          <div class="coordinate-item">
            <span>Longitude:</span>
            <span class="coordinate-value" id="lngDisplay">Not set</span>
          </div>
          <div class="coordinate-item">
            <span>Accuracy:</span>
            <span class="coordinate-value" id="accuracyDisplay">-</span>
          </div>
        </div>
      </div>

      <!-- Hidden coordinate fields -->
      <div style="display: none;">
        {{ form.latitude }}
        {{ form.longitude }}
      </div>

      <button class="btn-success" type="submit" id="submitBtn">Register as Mechanic</button>
    </form>
  </div>
</div>

<script>
// Geolocation functionality
function getCurrentLocation() {
    const spinner = document.getElementById('locationSpinner');
    const submitBtn = document.getElementById('submitBtn');
    const latDisplay = document.getElementById('latDisplay');
    const lngDisplay = document.getElementById('lngDisplay');
    const accuracyDisplay = document.getElementById('accuracyDisplay');
    const mapDiv = document.getElementById('map');
    
    spinner.style.display = 'inline-block';
    submitBtn.disabled = true;
    submitBtn.textContent = 'Detecting Location...';

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                
                // Update hidden fields
                document.getElementById('{{ form.latitude.id_for_label }}').value = lat;
                document.getElementById('{{ form.longitude.id_for_label }}').value = lng;
                
                // Update display
                latDisplay.textContent = lat.toFixed(6);
                lngDisplay.textContent = lng.toFixed(6);
                accuracyDisplay.textContent = `${Math.round(accuracy)}m`;
                
                // Update map display
                mapDiv.innerHTML = `<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: rgba(22, 163, 74, 0.2); color: #16a34a; text-align: center; padding: 20px;">
                    <div>
                        <div style="font-size: 32px; margin-bottom: 8px;">‚úÖ</div>
                        <div>Location Found!</div>
                        <small>Accuracy: ${Math.round(accuracy)}m</small>
                    </div>
                </div>`;
                
                spinner.style.display = 'none';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Register as Mechanic';
            },
            function(error) {
                console.error('Error getting location:', error);
                let errorMessage = 'Unable to get your location. ';
                
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage += 'Please allow location access in your browser settings.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage += 'Location information is unavailable.';
                        break;
                    case error.TIMEOUT:
                        errorMessage += 'Location request timed out.';
                        break;
                    default:
                        errorMessage += 'An unknown error occurred.';
                }
                
                alert(errorMessage);
                spinner.style.display = 'none';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Register as Mechanic';
            },
            {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 60000
            }
        );
    } else {
        alert('Geolocation is not supported by this browser. Please enter your coordinates manually.');
        spinner.style.display = 'none';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Register as Mechanic';
    }
}

function clearLocation() {
    document.getElementById('{{ form.latitude.id_for_label }}').value = '';
    document.getElementById('{{ form.longitude.id_for_label }}').value = '';
    document.getElementById('latDisplay').textContent = 'Not set';
    document.getElementById('lngDisplay').textContent = 'Not set';
    document.getElementById('accuracyDisplay').textContent = '-';
    document.getElementById('map').innerHTML = '<div style="color: #9ca3af; padding: 20px; text-align: center;"><div style="font-size: 32px; margin-bottom: 8px;">üó∫Ô∏è</div><div>Click "Current Location" to detect your coordinates</div></div>';
}

// Form validation
document.getElementById('mechanicForm').addEventListener('submit', function(e) {
    const lat = document.getElementById('{{ form.latitude.id_for_label }}').value;
    const lng = document.getElementById('{{ form.longitude.id_for_label }}').value;
    
    if (!lat || !lng) {
        if (!confirm('No location coordinates set. Customers may have difficulty finding your service center. Continue registration anyway?')) {
            e.preventDefault();
        }
    }
});

// Initialize form with any existing coordinates
document.addEventListener('DOMContentLoaded', function() {
    const lat = document.getElementById('{{ form.latitude.id_for_label }}').value;
    const lng = document.getElementById('{{ form.longitude.id_for_label }}').value;
    
    if (lat && lng) {
        document.getElementById('latDisplay').textContent = parseFloat(lat).toFixed(6);
        document.getElementById('lngDisplay').textContent = parseFloat(lng).toFixed(6);
        document.getElementById('map').innerHTML = `<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: rgba(22, 163, 74, 0.2); color: #16a34a; text-align: center; padding: 20px;">
            <div>
                <div style="font-size: 32px; margin-bottom: 8px;">‚úÖ</div>
                <div>Location Set</div>
            </div>
        </div>`;
    }
});
</script>

{% endblock %}